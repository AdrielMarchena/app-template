name: C/C++ CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:

    runs-on: ubuntu-latest

    env:
      LD_LIBRARY_PATH: ${GITHUB_WORKSPACE}/Game/vendor/fmodstudioapi20206linux/api/core/lib/x86_64
    
    steps:
    - uses: actions/checkout@v2
      
    - name: Install Packages
      run: |
        sudo apt update -qq
        sudo apt install -y git build-essential g++ make zip unzip
        sudo apt-get install -y --no-install-recommends libx11-dev libxcursor-dev libxrandr-dev libxinerama-dev libxi-dev libxext-dev libxfixes-dev libgl1-mesa-dev
    
    - name: Fetch git submodules
      run: git submodule update --init --recursive
    
    - name: premake5
      run: ./premake5 gmake2

    - name: make Debug x64
      run: make config=debug_x64

    - name: make Dist x64
      run: make config=dist_x64
      
    - name: zip release
      run: cp Game/bin/Dist-linux-x86_64/Game/Game Game/GameRun && zip -r Game.zip Game/assets Game/GameRun && rm Game/GameRun
      
    - uses: "marvinpinto/action-automatic-releases@latest"
      with:
        repo_token: "${{ secrets.GITHUB_TOKEN }}"
        automatic_release_tag: "latest"
        title: "Dist Build"
        prerelease: false
        draft: false
        files: |
          *.zip
            
